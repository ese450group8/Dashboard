<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="shortcut icon" href="http://cdn.osxdaily.com/wp-content/uploads/2014/06/health-app-icon.png">
  <title>Dashboard</title>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

  <!-- Tooltip css for hoverboxes -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <!-- Bootstrap Core CSS -->
  <link href="bootstrap.min.css" rel="stylesheet">

  <!-- MetisMenu CSS -->
  <link href="metisMenu.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link href="dataTables.bootstrap.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="sb-admin-2.css" rel="stylesheet">

  <!--Style-->
  <style>
  body {
    font-family: "Verdana", sans-serif;
  }

  #container {
    max-width: 750px;
    padding: 0 0;
    margin: 0 left;
  }

  h1 {
    text-transform: uppercase;
    font-weight: 600;
    color: rgb(0, 153, 255);
    margin: 0, 0, 0, 20px;
  }

  p {
    line-height: 1.5;
  }

  a, a:visited {
    text-decoration: none;
    color: rgb(0, 153, 255);
  }

  a:hover {
    background: rgba(0, 153, 255, 0.2);
  }

  th {
    font-weight: 300;
    color: white;
    text-transform: uppercase;
    background: rgb(0, 153, 255);
    padding: 5px 7px 5px 7px;
  }

  tr {
    border-width: 1px;
    border-color: grey;
  }

  td {
    text-align: center;
    padding: 10px 7px 10px 7px;
    /*border: 1px solid grey;*/
    background-color: rgba(230, 231, 233, 0.4);
  }
  </style>


</head>
<body>

  <div id="wrapper">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
      <div class="navbar-header">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/e/e1/Penn_Medicine_and_University_of_Pennsylvania_Health_System_logo.svg/1280px-Penn_Medicine_and_University_of_Pennsylvania_Health_System_logo.svg.png" alt="Image_Error" style="width:336px;height:49px;">
      </div>
      <!-- /.navbar-header -->

      <div class="navbar-default sidebar" role="navigation">
        <div class="sidebar-nav navbar-collapse">
          <ul class="nav" id="side-menu">
            <!edit for tabs>
            <li>
              <a href="testIndex.html"><i class="fa fa-table fa-fw"></i> Data Level</a>
            </li>
            <li>
              <a href="#"><i class="fa fa-folder-open-o fa-fw"></i> Patient Notes</a>
            </ul>
            
          </li>
        </ul>
      </div>
      <!-- /.sidebar-collapse -->
    </div>
    <!-- /.navbar-static-side -->
  </nav>
  <p></p>
  <!Sidebar>
  <div id="page-wrapper">
    <div class="row">
      <div class="col-lg-12">
        <!--<h1 class="page-header"></h1>-->
      </div>
      <!-- /.col-lg-12 -->
    </div>
    <! Population Data Location>
    <div id = "row">
      <div class = "row">
        <div class="col-lg-12">
          <h1 class="page-header"> Population Level Summary </h1>
        </div>
        <!-- /.col-lg-12 -->
      </div>
      <div class = "row">
        <div class="col-lg-12">
          <div class="panel panel-default">
            <div class="panel-heading">
            </div>
            <div class = "panel-body">
              <label>Above:</label><br>
              <input type="text" id="above">&nbsp;<label>mg/dL</label>
              <br><br><label>Below:</label><br>
              <input type="text" id="below">&nbsp;<label>mg/dL</label><br><br>
              <button onclick="updateTable()">Submit</button><br><br>
              <table class="table table-striped table-bordered table-hover" id = "dataTable">
                <thead>
                  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
                  <script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
                  <script src="jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
                  <link rel="stylesheet" href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css" type="text/css" title="no title" charset="utf-8"/>
                  <style>
                  table {
                    border-collapse: collapse;
                    width: 100%;
                  }
                  th, td {
                    text-align: left;
                    padding: 8px;
                  }
                  tr: nth-child(even){background-color: #f2f2f2}
                  th {
                    background-color: #4CAF50;
                    color: white;
                  }
                  </style>
                  <th> ID </th>
                  <th> Height </th>
                  <th> Weight </th>
                  <th> BMI </th>
                  <th> Gender </th>
                  <th> Last Updated Recording </th>
                  <!-- tooltip example -->
                  <th> 
                    <div class = "headerHover"> Fasting AVG
                      <span class = "hoverToolTip"> First glucose reading of the day before any meals </span>
                    </div>
                  </th>
                  <th> 
                    <div class = "headerHover"> Preprandial AVG
                      <span class = "hoverToolTip"> Glucose measured with 1 hour before eating</span>
                    </div>
                  </th>
                  <th> 
                    <div class = "headerHover"> Postprandial AVG
                      <span class = "hoverToolTip"> Glucose measured 1-3 hours after eating</span>
                    </div>
                  </th>
                  <th> 
                    <div class = "headerHover"> Random AVG
                      <span class = "hoverToolTip"> Glucose measured at random times, or relative time of meal not given </span>
                    </div>
                  </th>
                  <th> A1C Value </th>
                  <th> A1C Date </th>
                  <th> Last BP </th>
                  <th> Last Optho </th>
                  <th> Last Podiatry </th>
                  <th> 
                    <div class = "headerHover"> Priority Score
                      <span class = "hoverToolTip"> Score based on number of times patient's sugar levels were below 80 or above 200 </span>
                    </div>
                  </th>

                  <!-- CSS for hover -->
                  <style>
                  .headerHover:hover .hoverToolTip {
                    display: block;
                  }
                  .hoverToolTip {
                    display: none;
                    background: #404040;
                    margin-left: 28px;
                    padding: 10px;
                    position: absolute;
                    z-index: 1000;
                    width: 200px;
                    height: 100px;
                  }
                  </style>
                </thead>
                <tbody>
                  <script>
                  // function same as below to calculate preprandial, postprandial and random avgs
                  d3.csv("mealData.csv", function(meal) {
                    d3.csv("mealData.csv", function(breakfast) {
                      for (var b = breakfast.length - 1; b > -1; b--) {
                          for (var m = meal.length - 1; m > -1; m--) {
                            if (meal[m].ID === breakfast[b].ID &&
                              meal[m].time.slice(0,10) === breakfast[b].time.slice(0,10)) {
                              var mHour = parseInt(meal[m].time.slice(11,13));
                              var bHour = parseInt(breakfast[b].time.slice(11,13));
                              var mMinute = parseInt(meal[m].time.slice(14,16));
                              var bMinute = parseInt(breakfast[b].time.slice(14,16));
                              var mSecond = parseInt(meal[m].time.slice(17,19));
                              var bSecond = parseInt(breakfast[b].time.slice(17,19));

                              if (mHour < bHour) {
                                breakfast.splice(b, 1);
                              break;
                              } else if (mHour == bHour) {
                                if (mMinute < bMinute) {
                                  breakfast.splice(b, 1);
                                  break;
                                } else if (mMinute == bMinute) {
                                  if (mSecond < bSecond) {
                                    breakfast.splice(b, 1);
                                    break;
                                  } else if (mSecond == bSecond) {
                                    continue;
                                  }
                                }
                              } else {
                                meal.splice(m, 1);
                              }
                            }
                          }
                        }
                      breakfast = breakfast.filter(function(item) {
                        return (parseInt(item.time.slice(11,13)) >= 3);
                      });

                      d3.csv("mealData.csv", function(mdata) {
                        for (var b in breakfast) {
                          for (var meal in mdata) {
                            if (mdata[meal].ID === breakfast[b].ID && mdata[meal].time === breakfast[b].time) {
                              mdata[meal].isBreakfast = true;
                            }
                          }
                        }

                      d3.csv("glucoseData.csv", function(gdata) {
                      var temp = [];
                        for (var glucose in gdata) {
                          for (var meal in mdata) {
                            if (gdata[glucose].ID === mdata[meal].ID &&
                              gdata[glucose].time.slice(0,10) === mdata[meal].time.slice(0,10)) {
                              var gHour = parseInt(gdata[glucose].time.slice(11,13));
                              var mHour = parseInt(mdata[meal].time.slice(11,13));
                              var gMinute = parseInt(gdata[glucose].time.slice(14,16));
                              var mMinute = parseInt(mdata[meal].time.slice(14,16));

                            if ((gHour - mHour >= 2 && gHour - mHour <= 3) || 
                              (gHour - mHour == 1 && gMinute - mMinute >= 0)) {
                              gdata[glucose].flag = 'Postprandial';
                              break; 
                            } else if ((mHour - gHour == 0 && mMinute - gMinute > 0) || 
                                  (mHour - gHour == 1 && mMinute - gMinute <= 0)) {
                              if (mdata[meal].isBreakfast) {
                                gdata[glucose].flag = 'Fasting';
                              } else {
                                gdata[glucose].flag = 'Preprandial';
                              }
                            } else if (typeof gdata[glucose].flag == 'undefined') {
                              gdata[glucose].flag = 'Random';
                              }
                            }
                          }
                        }
                      
                      // array to keep track of patient IDs
                      var IDArray = [];
                      gdata.forEach(function(d,i) {
                        // need these to keep track of sums and calculate avg
                        var arrFast = [];
                        var arrPre = [];
                        var arrPost = [];
                        var arrRand = [];
                        var tempID = d.ID;
                        // function to check if this ID is already in IDArray. Does not work on IE6, 7, 8.
                        function isIncluded(arr,obj) {
                          return (arr.indexOf(obj) != -1);
                        }

                        var table = document.getElementById("dataTable");
                        var row = table.insertRow(table.rows.length);
                        // check if ID is already used, so only one patient summary is shown per table row
                        if (!isIncluded(IDArray, tempID)) {
                          // push tempID to IDArray to log it
                          IDArray.push(tempID);
    
                          // calculate averages of fasting, pre, post, etc.
                          for (var index in gdata) {
                            if (gdata[index].ID == tempID && gdata[index].flag == 'Postprandial') {
                              arrPost.push(gdata[index].glucose);
                            }
                            if (gdata[index].ID == tempID && gdata[index].flag == 'Preprandial') {
                              arrPre.push(gdata[index].glucose);
                            }
                            if (gdata[index].ID == tempID && gdata[index].flag == 'Random') {
                              arrRand.push(gdata[index].glucose);
                            }
                            if (gdata[index].ID == tempID && gdata[index].flag == 'Fasting') {
                              arrFast.push(gdata[index].glucose);
                            }
                          }
                          //console.log(arrPost);
                          // calculate sums / averages
                          var sumPost = 0;
                          for (var i = 0; i < arrPost.length; i++) {
                            sumPost += parseInt(arrPost[i]);
                            //console.log(sumPost);
                          }
                          var avgPost = Math.round((sumPost/arrPost.length)*100/100);

                          var sumPre = 0;
                          for (var i = 0; i < arrPre.length; i++) {
                            sumPre += parseInt(arrPre[i]);
                          }
                          var avgPre = Math.round((sumPre/arrPre.length)*100/100);

                          var sumRand = 0;
                          for (var i = 0; i < arrRand.length; i++) {
                            sumRand += parseInt(arrRand[i]);
                          }
                          var avgRand = Math.round((sumRand/arrRand.length)*100/100);
                          
                          var sumFast = 0;
                          for (var i = 0; i < arrFast.length; i++) {
                            sumFast += parseInt(arrFast[i]);
                          }

                          var avgFast = Math.round((sumFast/arrFast.length)*100/100);

                          var cell1 = row.insertCell(0);
                          row.onclick = function() {document.getElementById("patID").value = d.ID;};
                          var cell2 = row.insertCell(1);
                          var cell3 = row.insertCell(2);
                          var cell4 = row.insertCell(3);
                          var cell5 = row.insertCell(4);
                          // cell.onclick = ...
                          var cell6 = row.insertCell(5);
                          var cell7 = row.insertCell(6);
                          var cell8 = row.insertCell(7);
                          var cell9 = row.insertCell(8);
                          var cell10 = row.insertCell(9);
                          var cell11 = row.insertCell(10);
                          var cell12 = row.insertCell(11);
                          var cell13 = row.insertCell(12);
                          var cell14 = row.insertCell(13);
                          var cell15 = row.insertCell(14);
                          var cell16 = row.insertCell(15);

                          cell1.innerHTML = d.ID;
                          cell2.innerHTML = "hght";
                          cell3.innerHTML = "wght";
                          cell4.innerHTML = "bmi";
                          cell5.innerHTML = "gndr";
                          cell6.innerHTML = "last reading";
                          cell7.innerHTML = avgFast;
                          cell8.innerHTML = avgPre;
                          cell9.innerHTML = avgPost;
                          cell10.innerHTML = avgRand;
                          cell11.innerHTML = "av";
                          cell12.innerHTML = "ad";
                          cell13.innerHTML = "bp";
                          cell14.innerHTML = "optho";
                          cell15.innerHTML = "pod";
                          cell16.innerHTML = "score";
                        }
                      })
                    })
                  })
                })
              });
</script>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- /.row -->
<div class="row">
  <div class="col-lg-12">
    <h1 class="page-header"> Patient Level Summary </h1>
    <div class="panel panel-default">
      <div class="panel-heading">
        <!-- Write at top of Screen if you want -->
      </div>
      <!retrieving data from CSV file>
      <head>
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
        <link rel="stylesheet" href="http://onehackoranother.com/projects/jquery/tipsy/stylesheets/tipsy.css" type="text/css" title="no title" charset="utf-8"/>
        <style type="text/css">
        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
          opacity: 1;
        }

        .axis text { font-size:10px; }

        body { font: 12px sans-serif; }
        .circles { opacity: .5; }

        .tipsy { font-size:11px; margin-top:-10px;}

        .guide line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
          opacity: 0;
        }
        </style>
      </head>
      <body>
        <div id="chart">
            <script type="text/javascript">
            // Global Variables
            var thisID;
            var thisMonth;
            var thisYear;

            var colors = [];
            colors["Postprandial"] = d3.rgb(0, 0, 155);
            colors["Preprandial"] = d3.rgb(255, 128, 0);
            colors["Random"] = d3.rgb(0, 0, 0);
            colors["Fasting"] = d3.rgb(0,155,0);

            // Reads in the input PatientID
            function recordPatient() {
                var inputID = document.getElementById('patID').value;
                if (!isInt(inputID)) {
                  alert("Please submit a valid Patient ID");
                } else {
                  thisID = inputID;
                }
            }

            // Reads in the input month
            function recordMonth() {
              var inputMonth = document.getElementById('moID').value;
              if (!isInt(inputMonth)) {
                  alert("Please submit a valid month");
                } else {
                  thisMonth = inputMonth;
                }
            }

            // Reads in the input year
            function recordYear() {
              var inputYear = document.getElementById('yID').value;
              if (!isInt(inputYear)) {
                  alert("Please submit a valid year");
                } else {
                  thisYear = inputYear;
                }
            }

            // Returns true if value is valid integer
            function isInt(value) {
                return !isNaN(value) && parseInt(Number(value)) == value && !isNaN(parseInt(value, 10));
            }

            // set the stage
            var margin = {t:30, r:20, b:20, l:40 },
              w = 600 - margin.l - margin.r,
              h = 500 - margin.t - margin.b,
              x = d3.scale.linear().range([0, w]),
              y = d3.scale.linear().range([h - 60, 0]),
              //colors that will reflect pre or post prandial
              color = d3.scale.category10();

            var svg = d3.select("#chart").append("svg")
              .attr("width", w + margin.l + margin.r)
              .attr("height", h + margin.t + margin.b);

            // set axes, as well as details on their ticks
            var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(20)
              .tickSubdivide(true)
              .tickSize(6, 3, 0)
              .orient("bottom");

            var yAxis = d3.svg.axis()
              .scale(y)
              .ticks(20)
              .tickSubdivide(true)
              .tickSize(6, 3, 0)
              .orient("left");

            // group that will contain all of the plots
            var groups = svg.append("g").attr("transform", "translate(" + margin.l + "," + margin.t + ")");

            // array of the regions, used for the legend
            var regions = ["Postprandial", "Fasting", "Preprandial", "Random"];

            // bring in the data, and do everything that is data-driven
            d3.csv("glucoseData.csv", function(data) {

            // sort data alphabetically by region, so that the colors match with legend
            //data.sort(function(a, b) { return d3.ascending(a.region, b.region); })

            //var x0 = Math.max(-d3.min(data, function(d) { return d.trust; }), d3.max(data, function(d) { return d.trust; }));
              x.domain([0, 31]);
              y.domain([0, 500])
            

              // the legend color guide
              var legend = svg.selectAll("rect")
                  .data(regions)
                .enter().append("rect")
                .attr({
                  x: function(d, i) { return (40 + i*80); },
                  y: h,
                  width: 50,
                  height: 12
                })
                .style("fill", function(d) { return colors[d]; });


                // legend labels  
                svg.selectAll("text")
                  .data(regions)
                .enter().append("text")
                .attr({
                x: function(d, i) { return (40 + i*80); },
                y: h + 24,
                })
                .text(function(d) { return d; });

                // draw axes and axis labels
                svg.append("g")
                  .attr("class", "x axis")
                  .attr("transform", "translate(" + margin.l + "," + (h - 60 + margin.t) + ")")
                  .call(xAxis);

                svg.append("g")
                  .attr("class", "y axis")
                  .attr("transform", "translate(" + margin.l + "," + margin.t + ")")
                  .call(yAxis);

                svg.append("text")
                  .attr("class", "x label")
                  .attr("text-anchor", "end")
                  .attr("x", w + 50)
                  .attr("y", h - margin.t - 5)
                  .text("Day of Month");

                svg.append("text")
                  .attr("class", "y label")
                  .attr("text-anchor", "end")
                  .attr("x", -20)
                  .attr("y", 45)
                  .attr("dy", ".75em")
                  .attr("transform", "rotate(-90)")
                  .text("Blood Glucose Level");
            });
            
            // Plots the data points
            function updateGraph() {
              // Deletes previous data point circles
              d3.selectAll(".circles").remove();

              recordPatient();
              recordMonth();
              recordYear();

              d3.csv("mealData.csv", function(meal) {
                d3.csv("mealData.csv", function(breakfast) {
                  for (var b = breakfast.length - 1; b > -1; b--) {
                      for (var m = meal.length - 1; m > -1; m--) {
                        if (meal[m].ID === breakfast[b].ID &&
                          meal[m].time.slice(0,10) === breakfast[b].time.slice(0,10)) {
                          var mHour = parseInt(meal[m].time.slice(11,13));
                          var bHour = parseInt(breakfast[b].time.slice(11,13));
                          var mMinute = parseInt(meal[m].time.slice(14,16));
                          var bMinute = parseInt(breakfast[b].time.slice(14,16));
                          var mSecond = parseInt(meal[m].time.slice(17,19));
                          var bSecond = parseInt(breakfast[b].time.slice(17,19));

                          if (mHour < bHour) {
                            breakfast.splice(b, 1);
                          break;
                          } else if (mHour == bHour) {
                            if (mMinute < bMinute) {
                              breakfast.splice(b, 1);
                              break;
                            } else if (mMinute == bMinute) {
                              if (mSecond < bSecond) {
                                breakfast.splice(b, 1);
                                break;
                              } else if (mSecond == bSecond) {
                                continue;
                              }
                            }
                          } else {
                            meal.splice(m, 1);
                          }
                        }
                      }
                    }
                    breakfast = breakfast.filter(function(item) {
                      return (parseInt(item.time.slice(11,13)) >= 3);
                    });

                    d3.csv("mealData.csv", function(mdata) {
                      for (var b in breakfast) {
                        for (var meal in mdata) {
                          if (mdata[meal].ID === breakfast[b].ID && mdata[meal].time === breakfast[b].time) {
                            mdata[meal].isBreakfast = true;
                          }
                        }

                      }

                      d3.csv("glucoseData.csv", function(gdata) {
                      var temp = [];
                        for (var glucose in gdata) {
                          for (var meal in mdata) {
                            if (gdata[glucose].ID === mdata[meal].ID &&
                              gdata[glucose].time.slice(0,10) === mdata[meal].time.slice(0,10)) {
                              var gHour = parseInt(gdata[glucose].time.slice(11,13));
                              var mHour = parseInt(mdata[meal].time.slice(11,13));
                              var gMinute = parseInt(gdata[glucose].time.slice(14,16));
                              var mMinute = parseInt(mdata[meal].time.slice(14,16));

                            if ((gHour - mHour >= 2 && gHour - mHour <= 3) || 
                              (gHour - mHour == 1 && gMinute - mMinute >= 0)) {
                              gdata[glucose].flag = 'Postprandial';
                              break; 
                            } else if ((mHour - gHour == 0 && mMinute - gMinute > 0) || 
                                  (mHour - gHour == 1 && mMinute - gMinute <= 0)) {
                              if (mdata[meal].isBreakfast) {
                                gdata[glucose].flag = 'Fasting';
                              } else {
                                gdata[glucose].flag = 'Preprandial';
                              }
                            } else if (typeof gdata[glucose].flag == 'undefined') {
                              gdata[glucose].flag = 'Random';
                              }
                            }
                          }
                        }
                 
                      for (var index in gdata) {
                        if (gdata[index].ID == thisID && parseInt(gdata[index].time.slice(5, 7)) == thisMonth
                          && parseInt(gdata[index].time.slice(0, 4)) == thisYear) {
                          if (document.getElementById("Postprandial").checked && gdata[index].flag === 'Postprandial') {
                            temp.push(gdata[index]);
                          } else if (document.getElementById("Fasting").checked && gdata[index].flag === 'Fasting') {
                            temp.push(gdata[index]);
                          } else if (document.getElementById("Preprandial").checked && gdata[index].flag === 'Preprandial') {
                            temp.push(gdata[index]);  
                          } else if (document.getElementById("Random").checked && gdata[index].flag === 'Random') {
                            temp.push(gdata[index]);
                          } else if (document.getElementById("All").checked) {
                            temp.push(gdata[index]);
                          }
                        }
                      }


                      // style the circles, set their locations based on data
                      var circles =
                      groups.selectAll("circle")
                        .data(temp)
                        .enter().append("circle")
                        .attr("class", "circles")
                        .attr({
                          cx: function(d) { return x(+d.time.slice(8, 10)); },
                          cy: function(d) { return y(+d.glucose); },
                          r: 8 // size of balls
                          //id: function(d) { return d.glucose; }
                        })
                        // possibility: give a different color for balls based on pre/postprandial
                        .style("fill", function(d) { return colors[d.flag]; });


                      // what to do when we mouse over a bubble
                      var mouseOn = function() { 
                        var circle = d3.select(this);

                      // transition to increase size/opacity of bubble
                        circle.transition()
                        .duration(800).style("opacity", 1)
                        .attr("r", 16).ease("elastic");

                        // append lines to bubbles that will be used to show the precise data points.
                        // translate their location based on margins
                        svg.append("g")
                          .attr("class", "guide")
                        .append("line")
                          .attr("x1", circle.attr("cx"))
                          .attr("x2", circle.attr("cx"))
                          .attr("y1", +circle.attr("cy") + 26)
                          .attr("y2", h - margin.t - margin.b)
                          .attr("transform", "translate(40,20)")
                          .style("stroke", circle.style("fill"))
                          .transition().delay(200).duration(400).styleTween("opacity", 
                                function() { return d3.interpolate(0, .5); })

                        svg.append("g")
                          .attr("class", "guide")
                        .append("line")
                          .attr("x1", +circle.attr("cx") - 16)
                          .attr("x2", 0)
                          .attr("y1", circle.attr("cy"))
                          .attr("y2", circle.attr("cy"))
                          .attr("transform", "translate(40,30)")
                          .style("stroke", circle.style("fill"))
                          .transition().delay(200).duration(400).styleTween("opacity", 
                                function() { return d3.interpolate(0, .5); });

                      // function to move mouseover item to front of SVG stage, in case
                      // another bubble overlaps it
                      d3.selection.prototype.moveToFront = function() { 
                        return this.each(function() { 
                        this.parentNode.appendChild(this); 
                        }); 
                      };

                      // skip this functionality for IE9, which doesn't like it
                      if (!$.browser.msie) {
                        circle.moveToFront(); 
                        }
                      };
                      // what happens when we leave a bubble?
                      var mouseOff = function() {
                        var circle = d3.select(this);

                        // go back to original size and opacity
                        circle.transition()
                        .duration(800).style("opacity", .5)
                        .attr("r", 8).ease("elastic");

                        // fade out guide lines, then remove them
                        d3.selectAll(".guide").transition().duration(100).styleTween("opacity", 
                                function() { return d3.interpolate(.5, 0); })
                          .remove()
                      };

                      // run the mouseon/out functions
                      circles.on("mouseover", mouseOn);
                      circles.on("mouseout", mouseOff);

                      // control what shows after hovering mouse over a ball
                      circles.append("title")
                          .text(function(d) { return d.glucose + " mg/dL"; })

                      $(".circles").tipsy({ gravity: 's', });
                      });
                  });
                  });
              });
            }
          </script>


          <br><label>Enter Patient ID:</label><br>
          <input type="text" list="patientID" id="patID">
              <datalist id="patientID">
              </datalist>
          <br><br><label>Enter Month:</label><br>
          <input type="text" list="monthID" id="moID">
              <datalist id="monthID">
              </datalist>
          <br><br><label>Enter Year:</label><br>
          <input type="text" list="yearID" id="yID">
            <datalist id="yearID">
            </datalist>
          <br><br>
          <input type="radio" name="filter" id="All">All
          <input type="radio" name="filter" id="Postprandial">Postprandial
          <input type="radio" name="filter" id="Fasting">Fasting
          <input type="radio" name="filter" id="Preprandial">Preprandial
          <input type="radio" name="filter" id="Random">Random
          <br><br><button onclick="updateGraph()">Submit</button>


          <script type="text/javascript">
          var patOptions = '';
          var monthOptions = '';
          var yearOptions = '';
          d3.csv("glucoseData.csv", function(data) {
            for (var index in data) {
              // Add PatientID option if it doesn't exist already
              if (patOptions.indexOf(data[index].ID) == -1) {
                patOptions += '<option value="' + data[index].ID + '" />';
              }
            }
            document.getElementById('patientID').innerHTML = patOptions;
          });
          
          for (var i = 0; i < 12; i++) {
            monthOptions += '<option value="' + (i+1) + '" />';
            yearOptions += '<option value ="' + (2005+i) + '" />';
          };
          document.getElementById('monthID').innerHTML = monthOptions;
          document.getElementById('yearID').innerHTML = yearOptions;
          document.getElementById("All").checked = true;

          var upper;
          var lower;

          function recordAbove() {
            var inputAbove = document.getElementById('above').value;
            if (!isInt(inputAbove)) {
              alert("Please submit a valid upper threshold");
            } else {
              upper = inputAbove;
            }
          }

          function recordBelow() {
            var inputBelow = document.getElementById('below').value;
            if (!isInt(inputBelow)) {
              alert("Please submit a valid lower threshold");
            } else {
              lower = inputBelow;
            }
          }



          function updateTable() {
            var table = document.getElementById("dataTable");
            for (var i = table.rows.length - 1; i > 0; i--) {
              table.deleteRow(i);
            }

            recordAbove();
            recordBelow();

            d3.csv("mealData.csv", function(meal) {
              d3.csv("mealData.csv", function(breakfast) {
                for (var b = breakfast.length - 1; b > -1; b--) {
                    for (var m = meal.length - 1; m > -1; m--) {
                      if (meal[m].ID === breakfast[b].ID &&
                        meal[m].time.slice(0,10) === breakfast[b].time.slice(0,10)) {
                        var mHour = parseInt(meal[m].time.slice(11,13));
                        var bHour = parseInt(breakfast[b].time.slice(11,13));
                        var mMinute = parseInt(meal[m].time.slice(14,16));
                        var bMinute = parseInt(breakfast[b].time.slice(14,16));
                        var mSecond = parseInt(meal[m].time.slice(17,19));
                        var bSecond = parseInt(breakfast[b].time.slice(17,19));

                        if (mHour < bHour) {
                          breakfast.splice(b, 1);
                        break;
                        } else if (mHour == bHour) {
                          if (mMinute < bMinute) {
                            breakfast.splice(b, 1);
                            break;
                          } else if (mMinute == bMinute) {
                            if (mSecond < bSecond) {
                              breakfast.splice(b, 1);
                              break;
                            } else if (mSecond == bSecond) {
                              continue;
                            }
                          }
                        } else {
                          meal.splice(m, 1);
                        }
                      }
                    }
                  }
                breakfast = breakfast.filter(function(item) {
                  return (parseInt(item.time.slice(11,13)) >= 3);
                });

                d3.csv("mealData.csv", function(mdata) {
                  for (var b in breakfast) {
                    for (var meal in mdata) {
                      if (mdata[meal].ID === breakfast[b].ID && mdata[meal].time === breakfast[b].time) {
                        mdata[meal].isBreakfast = true;
                      }
                    }
                  }

                d3.csv("glucoseData.csv", function(gdata) {
                var temp = [];
                  for (var glucose in gdata) {
                    for (var meal in mdata) {
                      if (gdata[glucose].ID === mdata[meal].ID &&
                        gdata[glucose].time.slice(0,10) === mdata[meal].time.slice(0,10)) {
                        var gHour = parseInt(gdata[glucose].time.slice(11,13));
                        var mHour = parseInt(mdata[meal].time.slice(11,13));
                        var gMinute = parseInt(gdata[glucose].time.slice(14,16));
                        var mMinute = parseInt(mdata[meal].time.slice(14,16));

                      if ((gHour - mHour >= 2 && gHour - mHour <= 3) || 
                        (gHour - mHour == 1 && gMinute - mMinute >= 0)) {
                        gdata[glucose].flag = 'Postprandial';
                        break; 
                      } else if ((mHour - gHour == 0 && mMinute - gMinute > 0) || 
                            (mHour - gHour == 1 && mMinute - gMinute <= 0)) {
                        if (mdata[meal].isBreakfast) {
                          gdata[glucose].flag = 'Fasting';
                        } else {
                          gdata[glucose].flag = 'Preprandial';
                        }
                      } else if (typeof gdata[glucose].flag == 'undefined') {
                        gdata[glucose].flag = 'Random';
                        }
                      }
                    }
                  }
                
                // array to keep track of patient IDs
                var IDArray = [];
                var gdatafilter = gdata.filter(function(item) {
                  return (parseInt(item.glucose) > upper || parseInt(item.glucose) < lower);
                });

                gdatafilter.forEach(function(d,i) {
                  // need these to keep track of sums and calculate avg
                  var arrFast = [];
                  var arrPre = [];
                  var arrPost = [];
                  var arrRand = [];
                  var tempID = d.ID;
                  // function to check if this ID is already in IDArray. Does not work on IE6, 7, 8.
                  function isIncluded(arr,obj) {
                    return (arr.indexOf(obj) != -1);
                  }

                  var table = document.getElementById("dataTable");
                  var row = table.insertRow(table.rows.length);


                  // check if ID is already used, so only one patient summary is shown per table row
                  if (!isIncluded(IDArray, tempID)) {
                    // push tempID to IDArray to log it
                    IDArray.push(tempID);
                    
                    //calculate averages of fasting, pre, post, etc.
                    for (var index in gdata) {
                      if (gdata[index].ID == tempID && gdata[index].flag == 'Postprandial') {
                        arrPost.push(gdata[index].glucose);
                      }
                      if (gdata[index].ID == tempID && gdata[index].flag == 'Preprandial') {
                        arrPre.push(gdata[index].glucose);
                      }
                      if (gdata[index].ID == tempID && gdata[index].flag == 'Random') {
                        arrRand.push(gdata[index].glucose);
                      }
                      if (gdata[index].ID == tempID && gdata[index].flag == 'Fasting') {
                        arrFast.push(gdata[index].glucose);
                      }
                    }
                    // calculate sums / averages
                    var sumPost = 0;
                    for (var i = 0; i < arrPost.length; i++) {
                      sumPost += parseInt(arrPost[i]);
                      //console.log(sumPost);
                    }
                    var avgPost = Math.round((sumPost/arrPost.length)*100/100);

                    var sumPre = 0;
                    for (var i = 0; i < arrPre.length; i++) {
                      sumPre += parseInt(arrPre[i]);
                    }
                    var avgPre = Math.round((sumPre/arrPre.length)*100/100);

                    var sumRand = 0;
                    for (var i = 0; i < arrRand.length; i++) {
                      sumRand += parseInt(arrRand[i]);
                    }
                    var avgRand = Math.round((sumRand/arrRand.length)*100/100);
                    
                    var sumFast = 0;
                    for (var i = 0; i < arrFast.length; i++) {
                      sumFast += parseInt(arrFast[i]);
                    }

                    var avgFast = Math.round((sumFast/arrFast.length)*100/100);

                    var cell1 = row.insertCell(0);
                    row.onclick = function() {document.getElementById("patID").value = d.ID;};
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    var cell5 = row.insertCell(4);
                    // cell.onclick = ...
                    var cell6 = row.insertCell(5);
                    var cell7 = row.insertCell(6);
                    var cell8 = row.insertCell(7);
                    var cell9 = row.insertCell(8);
                    var cell10 = row.insertCell(9);
                    var cell11 = row.insertCell(10);
                    var cell12 = row.insertCell(11);
                    var cell13 = row.insertCell(12);
                    var cell14 = row.insertCell(13);
                    var cell15 = row.insertCell(14);
                    var cell16 = row.insertCell(15);

                    cell1.innerHTML = d.ID;
                    cell2.innerHTML = "hght";
                    cell3.innerHTML = "wght";
                    cell4.innerHTML = "bmi";
                    cell5.innerHTML = "gndr";
                    cell6.innerHTML = "last reading";
                    cell7.innerHTML = avgFast;
                    cell8.innerHTML = avgPre;
                    cell9.innerHTML = avgPost;
                    cell10.innerHTML = avgRand;
                    cell11.innerHTML = "av";
                    cell12.innerHTML = "ad";
                    cell13.innerHTML = "bp";
                    cell14.innerHTML = "optho";
                    cell15.innerHTML = "pod";
                    cell16.innerHTML = "score";
                  }
                })
              })
            })
          })
        });

          }

          </script>
          </div>
          </body>
          </div>
          </div>
          </div>
          </body>
          </html>
